<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perudo Leaderboard</title>
    <link rel="icon" type="image/jpeg" href="./tucano.jpg">
    <link rel="apple-touch-icon" href="./tucano.jpg">
    <style>
        :root {
            --color-primary: #2b7a6f;
            --color-primary-hover: #1f5a52;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #333333;
            --color-text-light: #666666;
            --color-success: #27ae60;
            --color-error: #e74c3c;
            --color-border: #ddd;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: var(--spacing-md);
            background: linear-gradient(-45deg, #f5f5f5, #e8f5e9, #e3f2fd, #f3e5f5);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--color-text);
            min-height: 100vh;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            padding-bottom: 80px;
        }
        
        .floating-dice {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            opacity: 0.05;
            font-size: 80px;
            animation: floatAround 20s linear infinite;
        }
        
        .floating-dice:nth-child(1) {
            left: 10%;
            animation-duration: 15s;
            animation-delay: 0s;
        }
        
        .floating-dice:nth-child(2) {
            right: 10%;
            animation-duration: 20s;
            animation-delay: 5s;
        }
        
        .floating-dice:nth-child(3) {
            left: 50%;
            animation-duration: 25s;
            animation-delay: 10s;
        }
        
        @keyframes floatAround {
            0% {
                transform: translateY(100vh) rotate(0deg);
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
            }
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1f5a52 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: 8px;
            margin-bottom: var(--spacing-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        header::before {
            content: 'üé≤';
            position: absolute;
            font-size: 60px;
            opacity: 0.1;
            animation: floatDice 6s ease-in-out infinite;
            left: 10%;
            top: 50%;
        }
        
        header::after {
            content: 'üé≤';
            position: absolute;
            font-size: 40px;
            opacity: 0.1;
            animation: floatDice 8s ease-in-out infinite;
            right: 15%;
            top: 30%;
            animation-delay: 2s;
        }
        
        @keyframes floatDice {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            position: relative;
            z-index: 1;
            animation: fadeInDown 0.8s ease;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: flex-end;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 2px 8px 2px 8px;
            padding-bottom: max(2px, env(safe-area-inset-bottom));
            height: 75px;
        }

        .nav-tabs button {
            flex: 1;
            padding: 8px 4px 4px 4px;
            border: none;
            background: none;
            color: var(--color-text-light);
            cursor: pointer;
            font-size: 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            transform: translateY(-16px);
        }
        
        .nav-tabs button[data-tab="home"] {
            flex: 1.2;
            font-size: 28px;
            padding: 10px 8px;
            margin: 0 4px;
            background: linear-gradient(135deg, var(--color-primary) 0%, #1f5a52 100%);
            color: white;
            box-shadow: 0 -4px 12px rgba(43, 122, 111, 0.4);
            border-radius: 20px 20px 16px 16px;
            transform: translateY(-16px);
        }
        
        .nav-tabs button[data-tab="home"].active {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1f5a52 100%);
            color: white;
        }
        
        .nav-tabs button span {
            font-size: 10px;
            font-weight: 500;
        }
        
        .nav-tabs button[data-tab="home"] span {
            font-size: 10px;
            font-weight: 600;
        }

        .nav-tabs button.active {
            color: var(--color-primary);
            background-color: rgba(43, 122, 111, 0.1);
        }
        
        .nav-tabs button:active {
            transform: translateY(-16px) scale(0.95);
        }
        
        .nav-tabs button[data-tab="home"]:active {
            transform: translateY(-16px) scale(0.95);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background-color: var(--color-surface);
            padding: var(--spacing-lg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: var(--spacing-md);
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--color-text);
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(43, 122, 111, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .players-list {
            margin-bottom: var(--spacing-lg);
        }

        .player-item {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: #f9f9f9;
            border-radius: 6px;
            align-items: center;
        }

        .player-item input {
            margin-bottom: 0;
        }

        .player-item button {
            background-color: var(--color-error);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
        }

        .player-item button:hover {
            background-color: #c0392b;
        }

        .player-input-wrapper {
            position: relative;
            flex: 1;
        }

        .player-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--color-border);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .player-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-full {
            width: 100%;
        }

        .result-form {
            margin-bottom: var(--spacing-md);
        }

        .result-item {
            padding: var(--spacing-md);
            background-color: #f9f9f9;
            border-radius: 6px;
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--color-primary);
        }

        .result-item h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--color-primary);
        }

        .result-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-lg);
        }

        .leaderboard-table thead {
            background-color: var(--color-primary);
            color: white;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .leaderboard-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .leaderboard-table .rank {
            font-weight: bold;
            color: var(--color-primary);
            min-width: 40px;
        }

        .leaderboard-table .points {
            font-weight: 600;
            color: var(--color-primary);
        }

        .leaderboard-table .positive {
            color: var(--color-success);
        }

        .leaderboard-table .negative {
            color: var(--color-error);
        }

        .game-history {
            margin-top: var(--spacing-lg);
        }

        .game-card {
            background-color: #f9f9f9;
            padding: var(--spacing-md);
            border-radius: 6px;
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--color-primary);
            position: relative;
        }
        
        .game-card .delete-game-btn {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background-color: var(--color-error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .game-card .delete-game-btn:hover {
            background-color: #c0392b;
            transform: scale(1.1);
        }

        .game-card h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--color-primary);
        }

        .game-card p {
            margin: 4px 0;
            font-size: 14px;
            color: var(--color-text-light);
        }

        .game-card-result {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .game-result-item {
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid var(--color-border);
        }

        .game-result-item strong {
            color: var(--color-primary);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--color-text-light);
        }

        .alert {
            padding: var(--spacing-md);
            border-radius: 6px;
            margin-bottom: var(--spacing-md);
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .sync-status {
            text-align: center;
            font-size: 12px;
            color: var(--color-text-light);
            margin-top: 8px;
        }

        .sync-status.synced {
            color: var(--color-success);
        }
        
        .player-name-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .player-name-tag {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f9f9f9;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }
        
        .player-name-tag.editing {
            background-color: #fff3cd;
            border-color: var(--color-primary);
        }
        
        .player-name-tag span {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .player-name-tag input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid var(--color-primary);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .player-name-tag .button-group {
            display: flex;
            gap: 4px;
            margin-left: 8px;
            flex-shrink: 0;
        }
        
        .player-name-tag button {
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .player-name-tag .btn-edit {
            background-color: #3498db;
        }
        
        .player-name-tag .btn-edit:hover {
            background-color: #2980b9;
        }
        
        .player-name-tag .btn-save {
            background-color: var(--color-success);
        }
        
        .player-name-tag .btn-save:hover {
            background-color: #229954;
        }
        
        .player-name-tag .btn-cancel {
            background-color: #95a5a6;
        }
        
        .player-name-tag .btn-cancel:hover {
            background-color: #7f8c8d;
        }
        
        .player-name-tag .btn-delete {
            background-color: var(--color-error);
        }
        
        .player-name-tag .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .add-player-form {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .add-player-form input {
            flex: 1;
        }
        
        .add-player-form button {
            flex-shrink: 0;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }
        
        .chart-container {
            background-color: white;
            padding: var(--spacing-lg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--color-primary);
            font-size: 18px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .podium-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .podium-card {
            background: white;
            padding: var(--spacing-md);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .podium-card h3 {
            margin: 0 0 var(--spacing-md) 0;
            font-size: 16px;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .podium-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .podium-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .podium-list li:last-child {
            border-bottom: none;
        }
        
        .podium-list .player-name {
            font-weight: 500;
        }
        
        .podium-list .count {
            background-color: var(--color-primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .result-form-row {
                grid-template-columns: 1fr;
            }

            .game-card-result {
                grid-template-columns: 1fr;
            }

            .leaderboard-table {
                font-size: 14px;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 8px;
            }

            header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="floating-dice">üé≤</div>
    <div class="floating-dice">üé≤</div>
    <div class="floating-dice">üé≤</div>
    
    <div class="container">
        <header>
            <h1>üé≤ Perudo Leaderboard</h1>
            <div class="sync-status" id="syncStatus">Connessione...</div>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn" data-tab="nuova-partita">
                ‚ûï
                <span>Nuova</span>
            </button>
            <button class="tab-btn" data-tab="giocatori">
                üë•
                <span>Giocatori</span>
            </button>
            <button class="tab-btn active" data-tab="home">
                üè†
                <span>Home</span>
            </button>
            <button class="tab-btn" data-tab="classifica">
                üèÜ
                <span>Classifica</span>
            </button>
            <button class="tab-btn" data-tab="storico">
                üìú
                <span>Storico</span>
            </button>
        </div>

        <!-- TAB: Home (Dashboard) -->
        <div id="home" class="tab-content active">
            <div class="card">
                <h2>üìä Dashboard</h2>
                
                <div class="podium-grid">
                    <div class="podium-card">
                        <h3>ü•á Primi Posti</h3>
                        <ul class="podium-list" id="firstPlaceList"></ul>
                    </div>
                    <div class="podium-card">
                        <h3>ü•à Secondi Posti</h3>
                        <ul class="podium-list" id="secondPlaceList"></ul>
                    </div>
                    <div class="podium-card">
                        <h3>ü•â Terzi Posti</h3>
                        <ul class="podium-list" id="thirdPlaceList"></ul>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="chart-container">
                        <h3>Punti Totali per Giocatore</h3>
                        <div class="chart-wrapper">
                            <canvas id="totalPointsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Evoluzione Classifica nel Tempo</h3>
                        <div class="chart-wrapper">
                            <canvas id="rankingEvolutionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Nuova Partita -->
        <div id="nuova-partita" class="tab-content">
            <div class="card">
                <h2>Nuova Partita</h2>
                
                <div class="form-group">
                    <label>Data della partita</label>
                    <input type="date" id="gameDate" />
                    <div id="dateAlert" style="margin-top: 8px;"></div>
                </div>

                <h3>Giocatori</h3>
                <div class="players-list" id="playersList"></div>
                <button class="btn btn-secondary btn-full" id="addPlayerBtn">+ Aggiungi Giocatore</button>

                <h3 style="margin-top: var(--spacing-lg);">Risultati</h3>
                <div id="resultsList"></div>

                <button class="btn btn-primary btn-full" id="saveGameBtn" style="margin-top: var(--spacing-lg);">Salva Partita</button>
                <div id="alert"></div>
            </div>
        </div>

        <!-- TAB: Classifica -->
        <div id="classifica" class="tab-content">
            <div class="card">
                <h2>Classifica Generale</h2>
                <table class="leaderboard-table" id="leaderboardTable">
                    <thead>
                        <tr>
                            <th>Posizione</th>
                            <th>Giocatore</th>
                            <th>Partite</th>
                            <th>Punti</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB: Storico -->
        <div id="storico" class="tab-content">
            <div class="card">
                <h2>Storico Partite</h2>
                <div id="gameHistoryList"></div>
            </div>
        </div>
        
        <!-- TAB: Giocatori -->
        <div id="giocatori" class="tab-content">
            <div class="card">
                <h2>Gestione Giocatori</h2>
                <p style="color: var(--color-text-light); margin-bottom: var(--spacing-lg);">Aggiungi o rimuovi giocatori dal database. Questi nomi appariranno nel menu a tendina quando crei una nuova partita.</p>
                
                <div class="add-player-form">
                    <input type="text" id="newPlayerName" placeholder="Nome nuovo giocatore" />
                    <button class="btn btn-primary" id="addPlayerNameBtn">Aggiungi</button>
                </div>
                
                <h3>Giocatori Salvati (<span id="playerCount">0</span>)</h3>
                <div class="player-name-list" id="playerNameList"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyACeAZdXhecfxCajTr03Byg_vAJd1y_p0Q",
            authDomain: "perudo-leaderbord.firebaseapp.com",
            databaseURL: "https://perudo-leaderbord-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "perudo-leaderbord",
            storageBucket: "perudo-leaderbord.firebasestorage.app",
            messagingSenderId: "804345086496",
            appId: "1:804345086496:web:6fb56a7f5546a88c027245"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State management
        let players = [];
        let games = [];
        let savedPlayerNames = [];
        let isOnline = true;

        // Initialize app
        function initApp() {
            const saved = localStorage.getItem('perudoData');
            if (saved) {
                const data = JSON.parse(saved);
                players = data.players || [];
                games = data.games || [];
                savedPlayerNames = data.savedPlayerNames || [];
            }
            
            setDefaultDate();
            renderPlayerInputs();
            loadFromFirebase();
            setupFirebaseListeners();
            updateSyncStatus();
            updateDashboard();
        }

        // Firebase Functions
        function loadFromFirebase() {
            db.ref('games').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    games = Object.values(snapshot.val());
                } else {
                    games = [];
                }
                extractPlayerNamesFromGames();
                updateLeaderboard();
                updateGameHistory();
                updateSyncStatus();
            }).catch(error => {
                console.log('Errore caricamento:', error);
                updateSyncStatus();
            });
        }

        function setupFirebaseListeners() {
            db.ref('games').on('value', snapshot => {
                if (snapshot.exists()) {
                    games = Object.values(snapshot.val());
                } else {
                    games = [];
                }
                extractPlayerNamesFromGames();
                updateLeaderboard();
                updateGameHistory();
                updateSyncStatus();
            });

            // Connessione
            db.ref('.info/connected').on('value', snap => {
                isOnline = snap.val();
                updateSyncStatus();
            });
        }
        
        function extractPlayerNamesFromGames() {
            // Extract all unique player names from game history
            const namesFromGames = new Set();
            games.forEach(game => {
                if (game.results) {
                    game.results.forEach(result => {
                        if (result.playerName && result.playerName.trim()) {
                            namesFromGames.add(result.playerName.trim());
                        }
                    });
                }
            });
            
            // Merge with existing saved names
            namesFromGames.forEach(name => {
                if (!savedPlayerNames.includes(name)) {
                    savedPlayerNames.push(name);
                }
            });
            
            savedPlayerNames.sort();
            savePlayerNamesToStorage();
        }

        function updateSyncStatus() {
            const status = document.getElementById('syncStatus');
            if (isOnline) {
                status.textContent = '‚úì Sincronizzato';
                status.className = 'sync-status synced';
            } else {
                status.textContent = '‚ö† Offline';
                status.className = 'sync-status';
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('gameDate');
            dateInput.value = today;
            checkDateAvailability(today);
            
            // Add event listener for date changes
            dateInput.addEventListener('change', function() {
                checkDateAvailability(this.value);
            });
        }
        
        function checkDateAvailability(date) {
            const dateAlert = document.getElementById('dateAlert');
            if (!date) {
                dateAlert.innerHTML = '';
                return;
            }
            
            const existingGame = games.find(g => g.date === date);
            if (existingGame) {
                dateAlert.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Esiste gi√† una partita per questa data. Puoi eliminarla dallo storico se vuoi sostituirla.</div>';
            } else {
                dateAlert.innerHTML = '';
            }
        }

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                const tabId = e.target.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                if (tabId === 'home') updateDashboard();
                if (tabId === 'classifica') updateLeaderboard();
                if (tabId === 'storico') updateGameHistory();
                if (tabId === 'giocatori') updatePlayerNameList();
            });
        });

        // Player management
        function addPlayerInput() {
            players.push({ id: Date.now(), name: '' });
            renderPlayerInputs();
        }

        function removePlayer(id) {
            players = players.filter(p => p.id !== id);
            renderPlayerInputs();
            renderResults();
        }

        function renderPlayerInputs() {
            const list = document.getElementById('playersList');
            
            list.innerHTML = players.map(player => `
                <div class="player-item">
                    <div class="player-input-wrapper">
                        <input 
                            type="text" 
                            placeholder="Nome giocatore" 
                            value="${player.name}"
                            data-player-id="${player.id}"
                            class="player-name-input"
                            autocomplete="off"
                        />
                        <div class="player-suggestions" data-player-id="${player.id}"></div>
                    </div>
                    <button type="button" data-player-id="${player.id}" class="player-remove-btn">Rimuovi</button>
                </div>
            `).join('');
            
            // Attach event listeners for name inputs
            document.querySelectorAll('.player-name-input').forEach(input => {
                const playerId = parseInt(input.dataset.playerId);
                const suggestionsDiv = document.querySelector(`.player-suggestions[data-player-id="${playerId}"]`);
                
                // Show suggestions on focus
                input.addEventListener('focus', function() {
                    showSuggestions(playerId, this.value);
                });
                
                // Filter suggestions on input
                input.addEventListener('input', function() {
                    showSuggestions(playerId, this.value);
                });
                
                // Update player name on change
                input.addEventListener('change', function() {
                    updatePlayerName(playerId, this.value);
                });
                
                // Hide suggestions on blur (with delay for click)
                input.addEventListener('blur', function() {
                    setTimeout(() => {
                        suggestionsDiv.classList.remove('show');
                    }, 200);
                });
            });
            
            // Attach event listeners for remove buttons
            document.querySelectorAll('.player-remove-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const playerId = parseInt(this.dataset.playerId);
                    removePlayer(playerId);
                });
            });
            
            renderResults();
        }
        
        function showSuggestions(playerId, filter) {
            const suggestionsDiv = document.querySelector(`.player-suggestions[data-player-id="${playerId}"]`);
            
            if (!suggestionsDiv) return;
            
            const filtered = savedPlayerNames.filter(name => 
                name.toLowerCase().includes(filter.toLowerCase())
            );
            
            if (filtered.length === 0) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            suggestionsDiv.innerHTML = filtered.map(name => `
                <div class="suggestion-item" data-name="${name}">${name}</div>
            `).join('');
            
            // Add click handlers to suggestions
            suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                    const selectedName = this.dataset.name;
                    const input = document.querySelector(`.player-name-input[data-player-id="${playerId}"]`);
                    input.value = selectedName;
                    updatePlayerName(playerId, selectedName);
                    suggestionsDiv.classList.remove('show');
                });
            });
            
            suggestionsDiv.classList.add('show');
        }

        function updatePlayerName(id, name) {
            const player = players.find(p => p.id === id);
            if (player) player.name = name;
            
            // Add name to saved names if not already present
            if (name && name.trim() && !savedPlayerNames.includes(name.trim())) {
                savedPlayerNames.push(name.trim());
                savedPlayerNames.sort();
                savePlayerNamesToStorage();
                renderPlayerInputs(); // Re-render to update datalist
            } else {
                renderResults();
            }
        }

        // Results management
        function renderResults() {
            const resultsList = document.getElementById('resultsList');
            if (players.length === 0) {
                resultsList.innerHTML = '<p class="empty-state">Aggiungi giocatori per inserire i risultati</p>';
                return;
            }

            resultsList.innerHTML = players.map((player, index) => `
                <div class="result-item">
                    <h4>${index + 1}. ${player.name || 'Giocatore ' + (index + 1)}</h4>
                    <div class="result-form-row">
                        <div class="form-group">
                            <label>Posizione finale</label>
                            <input 
                                type="number" 
                                min="1" 
                                max="${players.length}"
                                placeholder="Posizione"
                                id="pos-${player.id}"
                                class="position-input"
                                data-player-id="${player.id}"
                            />
                        </div>
                        <div class="form-group" id="nds-group-${player.id}">
                            <label>Dadi alla sconfitta (nds)</label>
                            <input 
                                type="number" 
                                min="0" 
                                max="5"
                                placeholder="Dadi"
                                id="nds-${player.id}"
                            />
                        </div>
                        <div class="form-group" id="ndv-group-${player.id}" style="display: none;">
                            <label>Dadi alla vittoria (ndv)</label>
                            <input 
                                type="number" 
                                min="0" 
                                max="5"
                                placeholder="Dadi"
                                id="ndv-${player.id}"
                            />
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Attach event listeners to position inputs
            document.querySelectorAll('.position-input').forEach(input => {
                input.addEventListener('input', function() {
                    const playerId = this.dataset.playerId;
                    const position = parseInt(this.value);
                    const ndsGroup = document.getElementById(`nds-group-${playerId}`);
                    const ndvGroup = document.getElementById(`ndv-group-${playerId}`);
                    
                    if (position === 1) {
                        ndsGroup.style.display = 'none';
                        ndvGroup.style.display = 'block';
                        document.getElementById(`nds-${playerId}`).value = '';
                    } else {
                        ndsGroup.style.display = 'block';
                        ndvGroup.style.display = 'none';
                        document.getElementById(`ndv-${playerId}`).value = '';
                    }
                });
            });
        }

        // Points calculation
        function calculatePoints(p, ng, nds, ndv, isWinner) {
            if (isWinner) {
                return (1 - p / ng) * (1 + ndv / 10);
            } else {
                return (1 - p / ng) * (1 - nds / (5 * ng));
            }
        }

        // Save game
        function saveGame() {
            const alert = document.getElementById('alert');
            alert.innerHTML = '';

            const gameDate = document.getElementById('gameDate').value;
            if (!gameDate) {
                showAlert('Seleziona una data', 'error');
                return;
            }

            if (players.length === 0) {
                showAlert('Aggiungi almeno un giocatore', 'error');
                return;
            }
            
            // Check if a game already exists for this date
            const existingGame = games.find(g => g.date === gameDate);
            if (existingGame) {
                showAlert('Esiste gi√† una partita salvata per questa data. Elimina prima quella esistente o scegli un\'altra data.', 'error');
                return;
            }

            const gameResults = [];
            const ng = players.length;
            let hasError = false;

            players.forEach(player => {
                const pos = parseInt(document.getElementById(`pos-${player.id}`).value);
                const ndsValue = document.getElementById(`nds-${player.id}`).value;
                const ndvValue = document.getElementById(`ndv-${player.id}`).value;
                
                const isWinner = pos === 1;
                const nds = isWinner ? 0 : parseInt(ndsValue);
                const ndv = isWinner ? parseInt(ndvValue) : 0;

                if (isNaN(pos)) {
                    hasError = true;
                    return;
                }
                
                if (isWinner && isNaN(ndv)) {
                    hasError = true;
                    return;
                }
                
                if (!isWinner && isNaN(nds)) {
                    hasError = true;
                    return;
                }

                const points = calculatePoints(pos, ng, nds, ndv, isWinner);

                gameResults.push({
                    playerId: player.id,
                    playerName: player.name,
                    position: pos,
                    nds: nds,
                    ndv: ndv,
                    points: points,
                    isWinner: isWinner
                });
            });

            if (hasError) {
                showAlert('Completa tutti i campi', 'error');
                return;
            }

            const game = {
                id: Date.now(),
                date: gameDate,
                players: players.map(p => p.name),
                results: gameResults
            };

            saveData(game);
            showAlert('Partita salvata con successo!', 'success');

            // Reset form
            setTimeout(() => {
                players = [];
                renderPlayerInputs();
                setDefaultDate();
                updateLeaderboard();
                updateGameHistory();
            }, 1500);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
        }

        // Data persistence
        function saveData(game) {
            // Salva localmente
            games.push(game);
            
            // Add player names to saved names
            game.players.forEach(playerName => {
                if (playerName && !savedPlayerNames.includes(playerName)) {
                    savedPlayerNames.push(playerName);
                }
            });
            savedPlayerNames.sort();
            
            localStorage.setItem('perudoData', JSON.stringify({ players: [], games, savedPlayerNames }));
            
            // Salva su Firebase
            db.ref('games/' + game.id).set(game).catch(error => {
                console.log('Errore salvataggio:', error);
                showAlert('Errore di sincronizzazione', 'error');
            });
        }
        
        function savePlayerNamesToStorage() {
            const saved = localStorage.getItem('perudoData');
            const data = saved ? JSON.parse(saved) : { players: [], games: [] };
            data.savedPlayerNames = savedPlayerNames;
            localStorage.setItem('perudoData', JSON.stringify(data));
        }

        // Leaderboard
        function updateLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardBody');
            
            if (games.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="4" class="empty-state">Nessuna partita ancora</td></tr>';
                return;
            }

            const playerStats = {};

            games.forEach(game => {
                if (game.results) {
                    game.results.forEach(result => {
                        if (!playerStats[result.playerName]) {
                            playerStats[result.playerName] = { points: 0, games: 0 };
                        }
                        playerStats[result.playerName].points += result.points;
                        playerStats[result.playerName].games += 1;
                    });
                }
            });

            const sorted = Object.entries(playerStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.points - a.points);

            leaderboardBody.innerHTML = sorted.map((player, index) => `
                <tr>
                    <td class="rank">#${index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.games}</td>
                    <td class="points ${player.points >= 0 ? 'positive' : 'negative'}">
                        ${player.points.toFixed(2)}
                    </td>
                </tr>
            `).join('');
        }
        
        // Dashboard and Statistics
        let chartInstances = {};
        
        function updateDashboard() {
            updatePodiumStats();
            updateTotalPointsChart();
            updateRankingEvolutionChart();
        }
        
        function updatePodiumStats() {
            const positions = { 1: {}, 2: {}, 3: {} };
            
            games.forEach(game => {
                if (game.results) {
                    game.results.forEach(result => {
                        if (result.position >= 1 && result.position <= 3) {
                            if (!positions[result.position][result.playerName]) {
                                positions[result.position][result.playerName] = 0;
                            }
                            positions[result.position][result.playerName]++;
                        }
                    });
                }
            });
            
            // Update first place
            const firstPlaceList = document.getElementById('firstPlaceList');
            const firstPlaceData = Object.entries(positions[1]).sort((a, b) => b[1] - a[1]).slice(0, 5);
            firstPlaceList.innerHTML = firstPlaceData.length > 0 
                ? firstPlaceData.map(([name, count]) => `
                    <li><span class="player-name">${name}</span><span class="count">${count}</span></li>
                `).join('')
                : '<li style="color: #999;">Nessun dato</li>';
            
            // Update second place
            const secondPlaceList = document.getElementById('secondPlaceList');
            const secondPlaceData = Object.entries(positions[2]).sort((a, b) => b[1] - a[1]).slice(0, 5);
            secondPlaceList.innerHTML = secondPlaceData.length > 0
                ? secondPlaceData.map(([name, count]) => `
                    <li><span class="player-name">${name}</span><span class="count">${count}</span></li>
                `).join('')
                : '<li style="color: #999;">Nessun dato</li>';
            
            // Update third place
            const thirdPlaceList = document.getElementById('thirdPlaceList');
            const thirdPlaceData = Object.entries(positions[3]).sort((a, b) => b[1] - a[1]).slice(0, 5);
            thirdPlaceList.innerHTML = thirdPlaceData.length > 0
                ? thirdPlaceData.map(([name, count]) => `
                    <li><span class="player-name">${name}</span><span class="count">${count}</span></li>
                `).join('')
                : '<li style="color: #999;">Nessun dato</li>';
        }
        
        function updateTotalPointsChart() {
            const playerStats = {};
            
            games.forEach(game => {
                if (game.results) {
                    game.results.forEach(result => {
                        if (!playerStats[result.playerName]) {
                            playerStats[result.playerName] = 0;
                        }
                        playerStats[result.playerName] += result.points;
                    });
                }
            });
            
            const sorted = Object.entries(playerStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('totalPointsChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (chartInstances.totalPoints) {
                chartInstances.totalPoints.destroy();
            }
            
            chartInstances.totalPoints = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([name]) => name),
                    datasets: [{
                        label: 'Punti Totali',
                        data: sorted.map(([, points]) => points),
                        backgroundColor: 'rgba(43, 122, 111, 0.8)',
                        borderColor: 'rgba(43, 122, 111, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateRankingEvolutionChart() {
            // Sort games by date
            const sortedGames = [...games].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Track cumulative points over time
            const playerEvolution = {};
            const dates = [];
            
            sortedGames.forEach(game => {
                if (game.results && game.date) {
                    dates.push(new Date(game.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }));
                    
                    game.results.forEach(result => {
                        if (!playerEvolution[result.playerName]) {
                            playerEvolution[result.playerName] = [];
                        }
                    });
                    
                    // Update cumulative points for all players
                    Object.keys(playerEvolution).forEach(playerName => {
                        const lastPoints = playerEvolution[playerName].length > 0 
                            ? playerEvolution[playerName][playerEvolution[playerName].length - 1]
                            : 0;
                        
                        const gameResult = game.results.find(r => r.playerName === playerName);
                        const newPoints = gameResult ? lastPoints + gameResult.points : lastPoints;
                        
                        playerEvolution[playerName].push(newPoints);
                    });
                }
            });
            
            // Get top 5 players by final points
            const topPlayers = Object.entries(playerEvolution)
                .map(([name, points]) => ({ name, finalPoints: points[points.length - 1] || 0 }))
                .sort((a, b) => b.finalPoints - a.finalPoints)
                .slice(0, 5)
                .map(p => p.name);
            
            const colors = [
                'rgba(43, 122, 111, 1)',
                'rgba(52, 152, 219, 1)',
                'rgba(231, 76, 60, 1)',
                'rgba(241, 196, 15, 1)',
                'rgba(155, 89, 182, 1)'
            ];
            
            const datasets = topPlayers.map((playerName, index) => ({
                label: playerName,
                data: playerEvolution[playerName],
                borderColor: colors[index],
                backgroundColor: colors[index].replace('1)', '0.1)'),
                borderWidth: 2,
                tension: 0.4,
                fill: false
            }));
            
            const ctx = document.getElementById('rankingEvolutionChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (chartInstances.rankingEvolution) {
                chartInstances.rankingEvolution.destroy();
            }
            
            chartInstances.rankingEvolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Game history
        function updateGameHistory() {
            const historyList = document.getElementById('gameHistoryList');
            
            if (games.length === 0) {
                historyList.innerHTML = '<div class="empty-state">Nessuna partita ancora</div>';
                return;
            }

            const sorted = [...games].sort((a, b) => new Date(b.date) - new Date(a.date));

            historyList.innerHTML = sorted.map(game => `
                <div class="game-card">
                    <button class="delete-game-btn" onclick="deleteGame(${game.id})" title="Elimina partita">√ó</button>
                    <h4>${new Date(game.date).toLocaleDateString('it-IT')}</h4>
                    <p><strong>Giocatori:</strong> ${game.players.join(', ')}</p>
                    <div class="game-card-result">
                        ${game.results.map(result => `
                            <div class="game-result-item">
                                <strong>${result.playerName}</strong><br>
                                Pos: ${result.position} | Dadi: ${result.nds} | Punti: ${result.points.toFixed(2)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function deleteGame(gameId) {
            if (!confirm('Sei sicuro di voler eliminare questa partita? Questa azione non pu√≤ essere annullata.')) {
                return;
            }
            
            // Remove from local array
            games = games.filter(g => g.id !== gameId);
            
            // Update localStorage
            localStorage.setItem('perudoData', JSON.stringify({ players: [], games, savedPlayerNames }));
            
            // Remove from Firebase
            db.ref('games/' + gameId).remove().then(() => {
                console.log('Partita eliminata con successo');
            }).catch(error => {
                console.log('Errore eliminazione:', error);
            });
            
            // Update all views
            updateGameHistory();
            updateLeaderboard();
            updateDashboard();
            
            // Recheck date availability
            const currentDate = document.getElementById('gameDate')?.value;
            if (currentDate) {
                checkDateAvailability(currentDate);
            }
        }
        
        // Player name management
        function updatePlayerNameList() {
            const listDiv = document.getElementById('playerNameList');
            const countSpan = document.getElementById('playerCount');
            
            if (!listDiv || !countSpan) return;
            
            countSpan.textContent = savedPlayerNames.length;
            
            if (savedPlayerNames.length === 0) {
                listDiv.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">Nessun giocatore salvato</div>';
                return;
            }
            
            listDiv.innerHTML = savedPlayerNames.map(name => `
                <div class="player-name-tag" id="tag-${name.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <span class="player-name-display">${name}</span>
                    <input type="text" class="player-name-edit" value="${name}" style="display: none;" />
                    <div class="button-group">
                        <button class="btn-edit" onclick="editPlayerName('${name.replace(/'/g, "\\'")}')" title="Modifica">‚úèÔ∏è</button>
                        <button class="btn-save" onclick="savePlayerName('${name.replace(/'/g, "\\'")}')" style="display: none;" title="Salva">‚úì</button>
                        <button class="btn-cancel" onclick="cancelEditPlayerName('${name.replace(/'/g, "\\'")}')" style="display: none;" title="Annulla">‚úï</button>
                        <button class="btn-delete" onclick="removePlayerName('${name.replace(/'/g, "\\'")}')" title="Elimina">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function editPlayerName(name) {
            const tagId = 'tag-' + name.replace(/[^a-zA-Z0-9]/g, '_');
            const tag = document.getElementById(tagId);
            if (!tag) return;
            
            tag.classList.add('editing');
            tag.querySelector('.player-name-display').style.display = 'none';
            tag.querySelector('.player-name-edit').style.display = 'block';
            tag.querySelector('.btn-edit').style.display = 'none';
            tag.querySelector('.btn-delete').style.display = 'none';
            tag.querySelector('.btn-save').style.display = 'inline-block';
            tag.querySelector('.btn-cancel').style.display = 'inline-block';
            tag.querySelector('.player-name-edit').focus();
            tag.querySelector('.player-name-edit').select();
        }
        
        function savePlayerName(oldName) {
            const tagId = 'tag-' + oldName.replace(/[^a-zA-Z0-9]/g, '_');
            const tag = document.getElementById(tagId);
            if (!tag) return;
            
            const newName = tag.querySelector('.player-name-edit').value.trim();
            
            if (!newName) {
                alert('Il nome non pu√≤ essere vuoto');
                return;
            }
            
            if (newName !== oldName && savedPlayerNames.includes(newName)) {
                alert('Questo nome esiste gi√†');
                return;
            }
            
            // Update the name in the array
            const index = savedPlayerNames.indexOf(oldName);
            if (index !== -1) {
                savedPlayerNames[index] = newName;
                savedPlayerNames.sort();
                savePlayerNamesToStorage();
                updatePlayerNameList();
            }
        }
        
        function cancelEditPlayerName(name) {
            updatePlayerNameList();
        }
        
        function addPlayerName() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();
            
            if (!name) {
                alert('Inserisci un nome');
                return;
            }
            
            if (savedPlayerNames.includes(name)) {
                alert('Questo giocatore esiste gi√†');
                return;
            }
            
            savedPlayerNames.push(name);
            savedPlayerNames.sort();
            savePlayerNamesToStorage();
            updatePlayerNameList();
            input.value = '';
            input.focus();
        }
        
        function removePlayerName(name) {
            if (!confirm(`Rimuovere ${name} dal database?`)) return;
            
            savedPlayerNames = savedPlayerNames.filter(n => n !== name);
            savePlayerNamesToStorage();
            updatePlayerNameList();
        }

        // Setup button listeners on DOM ready (iOS compatible)
        document.addEventListener('DOMContentLoaded', function() {
            // Add Player button
            document.getElementById('addPlayerBtn').addEventListener('click', function(e) {
                e.preventDefault();
                addPlayerInput();
            });

            // Save Game button
            document.getElementById('saveGameBtn').addEventListener('click', function(e) {
                e.preventDefault();
                saveGame();
            });
            
            // Add Player Name button
            const addPlayerNameBtn = document.getElementById('addPlayerNameBtn');
            if (addPlayerNameBtn) {
                addPlayerNameBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    addPlayerName();
                });
            }
            
            // Enter key on new player name input
            const newPlayerNameInput = document.getElementById('newPlayerName');
            if (newPlayerNameInput) {
                newPlayerNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addPlayerName();
                    }
                });
            }
        });

        // Initialize on load
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
